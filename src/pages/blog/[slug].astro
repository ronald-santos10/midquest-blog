---
import CategorySmall from "../../components/categorySmall.astro";
import Subscribe from "../../components/subscribe.astro";
import LayoutBlog from "../../layouts/LayoutBlog.astro";
import { getAllPosts } from "../../lib/api";
import type { Post } from "../../lib/types";

const apiUrl = import.meta.env.PUBLIC_API_URL;

export async function getStaticPaths() {
  const posts = await getAllPosts();

  return posts.map((post: Post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props as { post: Post };

if (!post) {
  throw new Error(`Post não encontrado.`);
}

const { title, description, body, publishedAt, cover, category, author } = post;

const coverUrl = cover?.formats?.large?.url
  ? `${apiUrl}${cover.formats.large.url}`
  : "/post.png";

const categoryLink = category?.slug ?? "sem-categoria";
const categoryName = category?.title ?? "Sem categoria";
const descriptionPost = description ?? "Sem descrição";
const bodyBlog = body ?? "Artigo sem conteúdo";
const authorName = author?.name ?? "Autor desconhecido";
const date = new Date(publishedAt).toLocaleDateString("pt-BR", {
  day: "2-digit",
  month: "long",
  year: "numeric",
});
---

<LayoutBlog
  title={title}
  description={descriptionPost}
  cover={coverUrl}
  category={categoryName}
  slug={post.slug}
>
  <div class="flex flex-col gap-4 md:gap-10">
    <div class="flex items-center gap-5 lg:gap-8 text-sm md:text-base">
      <CategorySmall link={`/category/${categoryLink}`} label={categoryName} />
      <span>{authorName}</span>
      <span>{date}</span>
    </div>

    <h1 class="text-4xl lg:text-5xl font-bold">{title}</h1>

    <img src={coverUrl} alt={title} />

    <p class="text-base md:text-lg text-gray-700">
      {bodyBlog}
    </p>

    <Subscribe />
  </div>
</LayoutBlog>
